#!/usr/bin/env ruby

require 'exif_gps_injector'

options = {}
OptionParser.new do |opt|
  opt.on('--kml-dir KML_DIR') { |o| options[:kml_dir] = o }
  opt.on('--input-dir INPUT_DIR') { |o| options[:input_dir] = o }
  opt.on('--output-dir OUTPUT_DIR') { |o| options[:output_dir] = o }
end.parse!

pwd = ENV['PWD']
options[:kml_dir] ||= pwd
options[:input_dir] ||= pwd
options[:output_dir] ||= pwd

kml = ExifGpsInjector::Kml.new(dir: options[:kml_dir])

Dir.glob(File.join(options[:input_dir], '/*.jpg')).each do |file|
  media = ExifGpsInjector::Media.new(file)
  location = kml.locate_at(media.original_date_time.to_s)
  lat, long, alt = location.split(' ')
  media.location = { gps_latitude: lat, gps_longitude: long, gps_altitude: alt }
end
